14-08-2021
В этом релизе изменена система опроса USB-IO цифровых входов согласно схеме КСУ_ШПЧ_20210814: 
1. Изменена процедура shutdown после проверки наличия АС-ОК сигнала на DI3. В новой схеме ПК включается/выключается поворотом ключа. Для выключения ПК достаточно включить RL2, подключенный параллельно контактам ключа, для имитации поворота ключа
2. Удалена проверка доворота ключа на входе DI2, см. пункт 1.
3. Добавлено включение реле RL0 and RL1 для дублирования контактора (Реле АВВ 220В) подключения аккумулятора к UPS +12V

23-08-2021
добавлена функция проверки состояния выводов 3 и 4  ПЧ (GS1,GS2)
добавлены окна аварийной остановки на активных страницах, с которых ведется управление приводом лебедки

01-09-2021
добавлен формат подписи "мм" к показанию энкодера на странице discrete
увеличен размер шрифта txtError on page Home для лучшего отображения сообщения об ошибке.
изменен формат страницы Home: увеличен шрифт текущих показателей, ошибки записываютмся в lbsplash крупным шрифтом вместо txbError

02-09-2021
HomePage: в сторках 159-160 добавлены смещения LowLimitInSteps для нижней точки энкодера при расчете текущего положения АРЗ
DiscreteX(Y): в строке 122 добавлены смещения LowLimitInSteps для нижней точки энкодера при расчете текущего положения АРЗ
TrackXPage(Y): строки 196, 360, (Y: 193, 357)
TrackXRecordPage(Y): строки 120, 488, 511 (Y: 120, 489, 512)
Дополнительное смещение на величину LowLimitInSteps нужно для привязки текущего показания энкодера к 0-му уровню.

03-09-2021
Улучшена читаемость страницы Setting - увеличены и выровнены шрифты
Исправлена ошибка при форматировании чисел после удаления стартовых нулей. Пример: .2 исправлено на 0.2
Исправлен формат кнопки Админ на главной странице

10-09-2021
Много изменений:
1. в погоне за снижением времени  опроса ПЛК сделал сокращенные функции опроса данных Axis&TR. Новые быстрые функции имеют суффикс ...Fast и MidFast. MidFast опрашивает только переменные: DistancePerRevInMM,ReductionCx,MotorMaxRevPerMin, D005_MF_InputsMonitor, Remote.
Fast опрашивает только две переменные: D005_MF_InputsMonitor, Remote.
2. функции записи типа cm.client.WriteSymbol("Axis_2.Fwd", false, reloadInfo: true);
имеют флаг reloadInfo:этот флаг полностью стирает таблицу данных и пререзаписывает ее снова. Это очень долго. Изменил на reloadInfo: false и снизил время исполнения в 100 раз!
3. изменения настроек длительности циклов PLCTask and I/O Idle Task никак не влияют на время записи считывания данных из TwinCAT в UX
4. COMM_TIMEOUT вынес в application: теперь точка установки времени таймера одна для всех страниц app.COMM_TIMEOUT
5. реализовал механизм защиты цикла точного таймера Hpt_Tick() от долгой загрузки данных twincat c помощью логики if(!busy){}. Также добавил busy=true/false для защиты от запуска таймера во время OnLoad page
6. ввел Hpt таймер на страницы TrackX(Y)RecordPage
7. создана логическая переменнная driveIsMoving: команда stopMoving теперь выполняется только один раз после завершения движения
8. исправлена ошибка с запуском времени движения на странице HomePage, добавлены условия проверки вывода счетчика времени.

18-03-2022
1.внесены изменения в модули DiscreteXPage.xaml.cs и DiscreteYPage.xaml.cs: 
стр 354 - к величине координаты новой точки перемещения добавлено значение энкодера в нижнем пределе
стр 540 - функция изменения цвета и блокировки кнопок - к расчету новой точки перемещения (режим перемещения на точку) добавлено значение энкодера в нижнем пределе. Для режима перемещение на заданную дистанцию ошибок не найдено.

Прим: в модуль FB_MoveAbsolutX значение дистанции нужно передавать в шагах энкодера, а в модуль FB_MoveRelative дистанцию в миллиметрах, так как расчет кол-ва шагов энкодера производится внутри модуля. Возможно стоит вынести эту процедуру умножения из цикла чтобы снизить вычислительную нагрузку.

28-03-2022
1. на страницу Settings добавлены кнопки КАлибровка для двух осей
2. в класс энкодера TR добавлено поле ZeroLevel для привязки оси к нулевому уровню после калибровки
3. переделана функция ReadXMLSettings in MainWindow.xaml.cs str 515-543, SettingPage.xaml.cs str 114-161
4. ValueEditPage.xaml.cs добавлена проверка - если вызов пришел от кнопок калибровки (000006 для первой страницы и 010006 для второй страницы), то дополнительно вызвать функцию расчета нулевого уровня ZeroLevel. стр 107 Функцию рпасчета ZeroLevel написать в классе коннектора в Mainwindow.xaml.cs

29-03-2022
1.на страницу ValueEditPage.xaml.cs добавлена функция ZeroLevelCalibration() для рассчета нового уровня нуля на основе текущего положения энкодера и введенного пользователем значения смещения.
2. на ту же страницу добавлена функция сброса в 0 значения калибровки при загрузке страницы, так как это промежуточное значение, а вычисляемое значение ZeroLevel пользователю не показываем
3. на той же странице добавлена блокировка возврата на страницу Settings в случае калибровки, чтобы пользователь успел прочитать сообщение о результате выполнения калибровки
4. после обновления значения ZeroLevel нужно обновить значения Low(Up)LimitsInSteps. Это происходит автоматически при загрузке страниц с управлением лебедкой
5. на страницу HomePage.xaml.cs добавлена проверка корректности установки концевиков и уведомления в случае необходимости проведения калибровки (стр 183-202)
 
03-04-2021
1.Выяснилось, что даже при отсутствии управления с КСУ, но при запущенном MX2_controll TwinCAT, частотники получают команды в ациклическом режиме по настройкам F002 & F003. Поэтому эти ячейки невозможно запрограммировать вручную. И там все время были нули. Поэтому,
в модуль инициализации переменных Axis_1 & Axis_2 (TwinCAT MX2_control) добавлены значения по умолчанию = 1.0 (сек) для переменных Acceleration & Deceleration. Это позволило передать в ШПЧ значения F002 & F003 ПЧ равное 1 секунде для разгона и торможения. Иначе были нули, и ПЧ выдавал ошибку при старте о прегрузке E02.2 (ну не мог сразу за 0 секунд разогнать привод))
2. добавил проверку условия  if (_indicator > -1) в строке 73 in module ValueEditPage для устранения ошибки при завершении процедуры калибровки: индекс номера индикатора (StoryBoards) выходил за границы
3. функция проверки наезда на рабочий концевик WSInputCheck(int d005, bool remote) добавлена в MainWindow стр. 671
4. Много изменений: внесена новая логика в обработку рабочих концевиков. Добавлены две новые переменные ARZ_ws_state & UPDN_ws_state для слежения за статусом рабочих концевиков. Добавлена блокировка по статусу раб.концевиков запуска движения в сопутствующем направлении. В противоположном ОК.
Смотри код на строках HomaPage 199-255
5. та же локига добавлена на страницу DiscretePage
6. на странице HomePage внесена инверсия в команды startmove, для согласования с установленной схемой

*************
При копировании bin в КСУ обязательно предварительно скопировать файл настроек XML!!!!!!!!!!!!!!
***************
7.разобраться с вычитанием чисел uint- это беззнаковые целые 32 бит - перед их вычитанием их нужно преобразовывать в целый int тип!! Иначе будет шикарный передоз, так как uint не может быть отрицательным - происходит переполнение по разрядам
8.перемещения на относительную дистанцию (строки 434 модуля DiscreteX(Y) Page) заменено на абсолютное перемещение, так как в модуле относительного перемещения FB_MoveRelate обнаружена критическая ошибка

04-04-2021
1. Редакция модуля TrackX(Y)Page. Справлен расчет TargetDist  in functions: MoveToTrackBegining(), TransformTrackToMoveAbsSet()
2. исправлен расчет ширины графика стр 119

05-04-2022
1. Замечено, что в режиме движения по пресетам, если оператор жмет кнопку старт, то движение по пресету начинается заново.Исправлено :
а) в процедуру StopMoving добавлено переключение режима statemode = 0 (1- движение на точку, 2-3 на расстояние), дополнительно в StopMoving для statemode=0 ("case 0") добавлена обработка стопа
б) в процедуру StartMoving добавлен сброс в statemode = 0 после отправки команды в ПЛК на движение
2. в TrackRecordX(Y)Page внесены поправки построения графика - сделаны такими же как в модулях TrackX(Y)Page
3. для процедур StartMoving & StopMoving в TrackRecordXPage сделана инверсия по case 1&2 для корректного отображения надписей о ходе движения. Точка 0 соответствует закрытому занавесу
4. там же: стр 140 добавлена инверсия отображения движения занавеса, изменен цвет занавеса с зеленого на бордовый
5. добавлена функция автоматического скрытия окна аларма на HomePage
6. исправлена ошибка при обратотке чисел с запятой в PresetValueEdit & ValueEditPage/ запятая заменяется на точку. иначе при проверке региональных настроек системы десятичный разделитель исчезает (стр 230 s_result = s_result.Replace(",", ".");)

06-04-2022
1. исправлена ошибка при расчете шкалы по оси Х в графике RecordTrackX, из-за этого масшбаб отображения положения занавеса строился неверно: правильно не приводить расчет к типу  uint, а присвоить значение с десятичным остатком: xAxis.Maximum = SceneWidth / 1000;
2. исправлены функции регулировки скорости и продолжительности сегмента в окне редактирования сегмента трека
3. график строится только в одну сторону, так как набор точек на треке модуль Chart не способен распознать в ином порядке - только напрямую. Поэтому для связывания треков нужно после создания трека №1 начать запись второго трека, в котором начальной точкой трека будет текущее положение занавеса (так как он стоит на месте окончания записи предыдущего трека)
4. на странице разметки MainWindow закомментированы кнопки перехода на TrackY, Test
5. кнопка Admin спрятана, паролем теперь защищены только страницы Settings и Test

08-04-2022
1. во всех модулях, использующих опрос twincat через Hpt добавлена проверка соединения на null
 // time to time the twincat is not ready and cm=null
                        if (cm is null)
                        {
                            throw new ArgumentNullException(nameof(cm));
                        }
                        else { cm.tryConnect(); }
2. таймер принудительного закрытия окон установлен только для страниц Settings & Testpage
3. при возврате со страницы ввода пароля на DiscretePageX замечена ошибка USB опроса
4. добавлены "красные шевроны" для дополнительной индикации наезда на рабочие концевики - требуется дополнительная отладка на месте
5. скрыты кнопки перехода на предыдущую страницу у представленных в навигационной панели страниц. Оставлены только у тех страниц, которых не видно в панели навигации.
6. страница TrackX(Y) отредактирована  - график и алгоритм расчета положения занавеса выравнены с параметрами TrackRecordX(Y)Page

09-04-2022
1. в строке проверки вводимого текста TrackRecordXpage (стр 909) исправлено правило проверки вводимых символов. Добавлена возможность ввода нижнего подчеркивания
 if (!((Char.IsLetterOrDigit(e.Text, 0) || e.Text.Equals("_")) && (TxtFileName.Text.Length<15)) )   

2. добавлена защита от сохранения некорректного трека, в котором меньше 3 точек путем добавления проверки и скрытия кнопки записи
BtTrackSave.Visibility = RecordTrack.Count > 3 ? Visibility.Visible : Visibility.Hidden;
3. на страницы TrackX(Y) добавлены расчеты ошибки измерения местоположения привода gap_in_steps = (int)(gap_in_mm * tr_1.EncStepsPerOneMM); Это позволит задавать парамет gap_in_mm в миллиметрах

11-04-2022
1. создана симуляция кнопок старт и стоп. добавалены алгоритмы наращивания положения энкодера в режиме эмуляции.
2. создана схема программного автомата и схемы трека для упрощения анализа кода TrackX_automate.vsd (Visio2010)
3. исправлено несколько ошибок логики переходов по автомату

14-04-2022
1. создана новая схема программного автомата для движения по треку. Количество State-ов увеличено. Цель: создать состояния "защелки" для точного определения фазы трека. Каждая фаза начинается со State=x и защелкивается на State=x+1, если пользователь
удерживает кнопку Старт. статус системы теперь надежно определяется при отпускании скнопки старт.
2. функционал движения по оси Х скопирован на ось Y.

23-04-2022
ниже перечисленные доработки сделаны после финального теста
1. доработка интерфейса создания трека:
	- изменено положение указателя направления трека - теперь не нужно скрывать эту иконку при наезде занавеса
	- исправлена ошибка вылета программы если список треков пустой
	- произвольное движение занавеса - внесены поправки в процедуры обработки нажатия и релиза кнопки СТАРТ, добавлен обязательный флаг driveIsMoving=true при любом нажатии на кнопку Старт, а также добавлена задержка 100мс перед подачей команды стоп, чтобы подготовить буфер ПЛК к чтению команды
	- обнаружено что занавес перелетает программные концевики на 9-10 см. Из-за этого образуются отрицательные точки начала трека в нижней границе и слишком большие в верхней. Внесены проверки выхода за границы лимитов при записи начальной точки трека